# K8S äº‹ä»¶å‘Šè­¦è§„åˆ™é…ç½®è¯´æ˜

## æ¦‚è¿°

KubeDoor K8Säº‹ä»¶å‘Šè­¦ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäºè§„åˆ™é©±åŠ¨çš„æ™ºèƒ½å‘Šè­¦è§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿæ ¹æ®é…ç½®çš„è§„åˆ™è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç† Kubernetes äº‹ä»¶ï¼Œå¹¶å‘é€ç›¸åº”çš„å‘Šè­¦é€šçŸ¥ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ¯ **è§„åˆ™é©±åŠ¨**: åŸºäº JSON é…ç½®æ–‡ä»¶çš„çµæ´»å‘Šè­¦è§„åˆ™
- ğŸ” **å¤šæ¡ä»¶åŒ¹é…**: æ”¯æŒå­—æ®µåŒ…å«/ä¸åŒ…å«ã€å¼€å¤´/ç»“å°¾åŒ¹é…ã€æ•°å€¼æ¯”è¾ƒç­‰å¤šç§åŒ¹é…æ¡ä»¶
- ğŸš« **æ™ºèƒ½è¿‡æ»¤**: å¿½ç•¥ DELETED äº‹ä»¶å’Œé…ç½®çš„å¿½ç•¥è§„åˆ™
- ğŸ”„ **çƒ­é‡è½½**: æ”¯æŒè¿è¡Œæ—¶é‡æ–°åŠ è½½å‘Šè­¦è§„åˆ™
- ğŸ“± **å¤šæ¸ é“é€šçŸ¥**: æ”¯æŒä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€é£ä¹¦ã€Slack ç­‰å¤šç§å‘Šè­¦é€šçŸ¥æ–¹å¼

## DELETED äº‹ä»¶è¯´æ˜

æ¥æ”¶åˆ° `eventStatus=DELETED` çš„äº‹ä»¶ï¼Œè¡¨ç¤ºè¯¥äº‹ä»¶è¶…è¿‡TTLæ—¶é—´åæ²¡æœ‰å†æ¬¡è§¦å‘ï¼Œäº‹ä»¶è¢«K8Såˆ é™¤ã€‚å¹¶ä¸æ˜¯å®é™…è§¦å‘äº†äº‹ä»¶ï¼Œæ‰€ä»¥DELETED äº‹ä»¶ä¸ä¼šè§¦å‘ä»»ä½•å‘Šè­¦ï¼ŒåŒæ—¶äº‹ä»¶çŠ¶æ€ä¼šè®°å½•åˆ°æ•°æ®åº“ã€‚

## å‘Šè­¦è§„åˆ™é…ç½®ç¤ºä¾‹

å‘Šè­¦è§„åˆ™é…ç½®æ–‡ä»¶configmapï¼š`kubedoor-master-file-cfg`

```json
{
  "global_ignore_rules": [
    {
      "name": "ç¯å¢ƒè¿‡æ»¤è§„åˆ™(æ’é™¤éç”Ÿäº§ç¯å¢ƒ[æ³¨æ„:å½“å‰æœªå¼€å¯])",
      "enabled": false,
      "conditions": {
        "k8s": {
          "not_contains": ["prod"]
        }
      }
    },
    {
      "name": "å¸¸è§å¿½ç•¥äº‹ä»¶[ç¤ºä¾‹:é˜²æ­¢å‘Šè­¦è§„åˆ™ä¸­æœ‰æ­£å¸¸äº‹ä»¶è¢«åŒ¹é…åˆ°,å¯ä»¥åŠ åˆ°å¿½ç•¥è§„åˆ™ä¸­]",
      "enabled": true,
      "conditions": {
        "reason": {
          "contains": ["BackOffStart", "SuccessfulCreate", "SuccessfulMountVolume"]
        }
      }
    }
  ],
  "alert_rules": [
    {
      "name": "å…³é”®äº‹ä»¶å‘Šè­¦",
      "enabled": true,
      "severity": "critical",
      "conditions": {
        "reason": {
          "contains": ["OOM", "NodeNotReady", "Unreachable"]
        },
        "level": {
          "contains": ["Warning"]
        }
      }
    },
    {
      "name": "å¥åº·æ£€æŸ¥å¤±è´¥å‘Šè­¦",
      "enabled": true,
      "severity": "warning",
      "conditions": {
        "reason": {
          "contains": ["Unhealthy"]
        },
        "name": {
          "not_starts_with": ["deploy-datax-cloud-"]
        },
        "count": {
          "greater_than": 1
        }
      }
    },
    {
      "name": "èµ„æºå‹åŠ›å‘Šè­¦",
      "enabled": true,
      "severity": "warning",
      "conditions": {
        "reason": {
          "contains": ["Pressure", "OutOf", "Evict"]
        }
      }
    }
  ]
}
```

## è§„åˆ™è¯´æ˜

### 1. è§„åˆ™åŒ¹é…é€»è¾‘

- å…±2ä¸ªè§„åˆ™ç»„ï¼Œæ¯ä¸ªè§„åˆ™ç»„æœ‰è‹¥å¹²æ¡è§„åˆ™ã€‚
- å¯ä»¥é€šè¿‡ `enabled` å­—æ®µæ§åˆ¶è§„åˆ™æ˜¯å¦å¼€å¯ã€‚
- è§¦å‘K8Säº‹ä»¶åï¼Œå…ˆè¿›å…¥`global_ignore_rules`**è§„åˆ™ç»„**ï¼Œ**ä»»æ„ä¸€æ¡è§„åˆ™**åŒ¹é…å³å¿½ç•¥äº‹ä»¶ã€‚å¦‚æœæœªå¿½ç•¥ï¼Œåˆ™è¿›å…¥`alert_rules`**è§„åˆ™ç»„**ï¼Œ**ç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™**ç”Ÿæ•ˆï¼Œå³è§¦å‘å‘Šè­¦ã€‚**

### 2. è§„åˆ™ç»„ä¹‹é—´çš„å…³ç³»

1. **global_ignore_rules**: å¤šæ¡å¿½ç•¥è§„åˆ™ä¹‹é—´æ˜¯ **OR** å…³ç³»ï¼Œä»»æ„ä¸€æ¡è§„åˆ™åŒ¹é…å³å¿½ç•¥äº‹ä»¶ã€‚
2. **alert_rules**: å¤šæ¡å‘Šè­¦è§„åˆ™ä¹‹é—´æ˜¯ **OR** å…³ç³»ï¼ŒæŒ‰æ•°ç»„é¡ºåºåŒ¹é…ï¼Œç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™ç”Ÿæ•ˆã€‚

### 3. å•æ¡è§„åˆ™å†…çš„æ¡ä»¶å…³ç³»

æ¯æ¡è§„åˆ™çš„ `conditions` å†…çš„å¤šä¸ªå­—æ®µæ¡ä»¶ä¹‹é—´æ˜¯ **AND** å…³ç³»ï¼Œå¿…é¡»æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³æ‰ç®—åŒ¹é…ï¼š

```json
{
  "conditions": {
    "reason": { "contains": ["OOMKilling"] }, // æ¡ä»¶1
    "level": { "equals": "Warning" }, // æ¡ä»¶2
    "namespace": { "not_contains": ["test"] } // æ¡ä»¶3
  }
  // åªæœ‰å½“ reasonåŒ…å«OOMKilling AND levelç­‰äºWarning AND namespaceä¸åŒ…å«test æ—¶æ‰åŒ¹é…
}
```

### 4. å­—æ®µæ¡ä»¶å†…çš„å€¼å…³ç³»

å¯¹äºåŒä¸€å­—æ®µçš„å¤šä¸ªå€¼ï¼Œå…³ç³»å–å†³äºæ¡ä»¶ç±»å‹ï¼š

- **contains**: å¤šä¸ªå€¼ä¹‹é—´æ˜¯ **OR** å…³ç³»ï¼ˆåŒ…å«ä»»ä¸€å€¼å³åŒ¹é…ï¼‰
- **not_contains**: å¤šä¸ªå€¼ä¹‹é—´æ˜¯ **AND** å…³ç³»ï¼ˆä¸åŒ…å«ä»»ä½•å€¼æ‰åŒ¹é…ï¼‰
- **starts_with/ends_with**: å¤šä¸ªå€¼ä¹‹é—´æ˜¯ **OR** å…³ç³»
- **not_starts_with/not_ends_with**: å¤šä¸ªå€¼ä¹‹é—´æ˜¯ **AND** å…³ç³»

## æ”¯æŒçš„æ¡ä»¶ç±»å‹

| æ¡ä»¶ç±»å‹          | è¯´æ˜                      | ç¤ºä¾‹                                               |
| ----------------- | ------------------------- | -------------------------------------------------- |
| `contains`        | å­—æ®µåŒ…å«ä»»ä¸€æŒ‡å®šå€¼        | `{"reason": {"contains": ["OOM", "Failed"]}}`      |
| `not_contains`    | å­—æ®µä¸åŒ…å«ä»»ä½•æŒ‡å®šå€¼      | `{"namespace": {"not_contains": ["test", "dev"]}}` |
| `equals`          | å­—æ®µç­‰äºæŒ‡å®šå€¼            | `{"level": {"equals": "Warning"}}`                 |
| `not_equals`      | å­—æ®µä¸ç­‰äºæŒ‡å®šå€¼          | `{"eventStatus": {"not_equals": "DELETED"}}`       |
| `starts_with`     | å­—æ®µä»¥æŒ‡å®šå€¼å¼€å¤´          | `{"name": {"starts_with": ["deploy-"]}}`           |
| `not_starts_with` | å­—æ®µä¸ä»¥æŒ‡å®šå€¼å¼€å¤´        | `{"name": {"not_starts_with": ["test-"]}}`         |
| `ends_with`       | å­—æ®µä»¥æŒ‡å®šå€¼ç»“å°¾          | `{"name": {"ends_with": ["-service", "-pod"]}}`    |
| `not_ends_with`   | å­—æ®µä¸ä»¥æŒ‡å®šå€¼ç»“å°¾        | `{"name": {"not_ends_with": ["-test", "-debug"]}}` |
| `greater_than`    | æ•°å€¼å¤§äºï¼ˆä»… count å­—æ®µï¼‰ | `{"count": {"greater_than": 3}}`                   |
| `less_than`       | æ•°å€¼å°äºï¼ˆä»… count å­—æ®µï¼‰ | `{"count": {"less_than": 10}}`                     |

## æ”¯æŒçš„äº‹ä»¶å­—æ®µ

| å­—æ®µå | æè¿° |
|--------|------|
| level | äº‹ä»¶çº§åˆ«ï¼ˆNormal/Warningï¼‰ |
| count | äº‹ä»¶å‘ç”Ÿæ¬¡æ•° |
| kind | å¯¹è±¡çš„ç±»å‹ |
| k8s | K8Sé›†ç¾¤åç§° |
| namespace | å‘½åç©ºé—´ |
| name | å¯¹è±¡çš„åç§° |
| reason | äº‹ä»¶åŸå›  |
| message | äº‹ä»¶è¯¦ç»†æ¶ˆæ¯ |
| reportingComponent | äº‹ä»¶æ¥æº |
| reportingInstance | æ¥æºIP |

#### æ³¨æ„ï¼šK8Säº‹ä»¶å‘Šè­¦å»é‡æ—¶é—´çª—å£ï¼Œé€šè¿‡å˜é‡`ALERT_DEDUP_WINDOW`æ§åˆ¶ï¼ˆconfigmapï¼škubedoor-configï¼‰ï¼Œé»˜è®¤300ç§’ã€‚ï¼ˆå³é‡å¤äº‹ä»¶å‘Šè­¦5åˆ†é’Ÿæœ€å¤šé€šçŸ¥ä¸€æ¬¡ã€‚ï¼‰
